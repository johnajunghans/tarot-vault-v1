*This document contains specifications for the MVP and an ordered list of stages for building the MVP. When updating this document, use strikethrough (~~complete~~) to indicate completion of a step or entire plan topic.*
# 0_Specifications
*Project information, useful links, and change log*
## 0.1_Tech Stack
### 0.1.1_initial package.json file
```json
{
	"name": "tarot-vault-v1",
	"version": "0.1.0",
	"private": true,
	"scripts": {
		"dev": "npm-run-all --parallel dev:frontend dev:backend",
		"dev:frontend": "next dev",
		"dev:backend": "convex dev",
		"predev": "convex dev --until-success && convex dashboard",
		"build": "next build",
		"start": "next start",
		"lint": "eslint ."
	},
	"dependencies": {
		"@base-ui/react": "^1.1.0",
		"@clerk/clerk-react": "^5.60.0",
		"@clerk/nextjs": "^6.37.1",
		"class-variance-authority": "^0.7.1",
		"clsx": "^2.1.1",
		"convex": "^1.31.7",
		"hugeicons-react": "^0.4.0",
		"next": "^16.1.6",
		"react": "^19.2.4",
		"react-dom": "^19.2.4",
		"tailwind-merge": "^3.4.0"
	},
	"devDependencies": {
		"@convex-dev/eslint-plugin": "^1.1.1",
		"@tailwindcss/postcss": "^4.1.18",
		"@types/node": "^24.10.9",
		"@types/react": "^19.2.10",
		"@types/react-dom": "^19.2.3",
		"eslint": "^9.39.2",
		"eslint-config-next": "^16.1.6",
		"npm-run-all2": "^8.0.4",
		"prettier": "^3.8.1",
		"tailwindcss": "^4.1.18",
		"tw-animate-css": "^1.4.0",
		"typescript": "^5.9.3"
	}
}
```
### 0.1.2_Core
- React + NextJS
- TypeScript
### 0.1.3_Frontend
### 0.1.4_Backend
#### 0.1.4.1_Database
- Convex
#### 0.1.4.2_Authentication
- Clerk
#### 0.1.4.3_Server
- Vercel
## 0.2_Details
### 0.2.1_Frontend
#### 0.2.1.1_Shadcn
##### 0.2.1.1.1_initial components.json file

```json
{
	"$schema": "https://ui.shadcn.com/schema.json",
	"style": "base-nova",
	"rsc": true,
	"tsx": true,
	"tailwind": {
		"config": "",
		"css": "app/globals.css",
		"baseColor": "stone",
		"cssVariables": true,
		"prefix": ""
	},
	"iconLibrary": "hugeicons",
	"rtl": false,
	"aliases": {
		"components": "@/components",
		"utils": "@/lib/utils",
		"ui": "@/components/ui",
		"lib": "@/lib",
		"hooks": "@/hooks"
	},
	"registries": {}
}
```
##### 0.2.1.1.2_expected components
- Avatar
- Badge
- Breadcrumb
- Button
- Button Group
- Calendar
- Card
- Collapsable
- Date Picker
- Dialog
- Dropdown Menu
- Empty
- Field
- Input
- Label
- Popover
- Progress
- Radio Group
- Resizable
- Scroll Area
- Select
- Separator
- Sidebar
- Skeleton
- Sonner
- Spinner
- Switch
- Tabs
- Toggle
- Toggle Group
- Tooltip
#### 0.2.1.2_Forms
- react-hook-form + zod
	- Use in combination with shadcn/ui Field component to build forms
#### 0.2.1.3_Dark Mode
- next-themes
	- As outlined in shadcn/ui for use with nextjs
### 0.2.2_Backend
#### 0.2.2.1_Convex
##### 0.2.2.1.1_Tables
###### 0.2.2.1.1.1_users
**Properties**
- _id: users._id
- _creationTime: number (auto-generated by Convex, milliseconds since epoch)
- authId: string (id generated by Clerk)
- tokenIdentifier: string 
- updatedAt: number (milliseconds since epoch)
- lastSignedIn: number (milliseconds since epoch)
- name: string
- email: string
- settings: object
	- appearance: object
		- theme: "light" | "dark" | "system" (default = "system")
	- preferences: object
		- useReverseMeanings: "auto" | "always" | "never" (default = "auto")
	- notifications: object
		- private: object
			- showToasts: boolean (default = true) *whether to show toasts on crud operations*

**Indexes**
- by_authId: ["authId"]
###### 0.2.2.1.1.2_readings
**Custom Card Type**
- Card: object
	- id: number (integer between 0 and 77)
	- position?: number (integer between 1 and 78)
	- reversed: boolean
	- notes: string

**Properties**
- _id: readings._id
- _creationTime: number (auto-generated by Convex, milliseconds since epoch)
- userId: users._id
- updatedAt: number (milliseconds since epoch)
- question: string
- date: number (milliseconds since epoch)
- drawMethod: “manual” | “digital”
- digitalDrawRandomness?: “pseudo” | “real” (user just needs a deck of playing cards and a 6 sided die to generate truly random values for card draws)
- spread: object
    - id: spreads._id
    - version: number (between 0 and 77)
- useReverseMeanings: boolean
- useSignifierCard: boolean
- results: object
    - signifier?: Card
    - cards: Card Array
- title?: string
- context?: string
- image?: _storage._id
- parent?: object
    - type: “reading”
    - id: readings._id
- notes?: string
- interpretations?: interpretations._id Array
- starred: boolean (default = false)

**Indexes**
- by_userId_and_updatedAt: ["userId", "updatedAt"]
- by_userId_and_starred: ["userId", "starred"]

###### 0.2.2.1.1.3_interpretations
**Properties**
- _id: interpretations._id
- _creationTime: number (auto-generated by Convex, milliseconds since epoch)
- userId: users._id
- readingId: readings._id (foreign key - one to many: readings can have many interpretations)
- updatedAt: number (milliseconds since epoch)
- content: string
- source: “self” | “ai”
- focus?: string
- aiMetadata: object
    - tier: “free” | “premium”
    - model: object
        - name: string
        - version: string
    - requestTime: number (milliseconds since epoch)
    - totalCost: number
    - tokensUsed: number
    - systemPrompt?: string

**Indexes**
- by_readingId: ["readingId"]
- by_userId_and_source: ["userId", "source"]

###### 0.2.2.1.1.4_spreads
**Properties**
- _id: spreads._id
- _creationTime: number (auto-generated by Convex, milliseconds since epoch)
- userId: users._id
- updatedAt: number (milliseconds since epoch)
- name: string
- description?: string
- numberOfCards: number (integer between 1 and 78)
- positions: objectArray
    - name: string
    - description?: string
    - transform: object
        - x: number
        - y: number
        - r: number
        - z: number

**Indexes**
- by_userId_and_updatedAt: ["userId", "updatedAt"]

## 0.3_Resources
- [Convex: NextJS+Convex Quickstart](https://docs.convex.dev/quickstart/nextjs)
- [Convex: NextJS+Convex Docs](https://docs.convex.dev/client/nextjs/app-router/)
- [Convex: NextJS+Convex+Clerk Setup](https://docs.convex.dev/auth/clerk#nextjs)
- [Clerk: Convex+Clerk Setup](https://clerk.com/docs/guides/development/integrations/databases/convex)
- [Shadcn: next-themes darkmode setup](https://ui.shadcn.com/docs/dark-mode/next)
- [Convex: storing users in the convex database](https://docs.convex.dev/auth/database-auth)
## 0.4_Git
*Protocol for git version control*
### 0.4.1_Repo Info
- url: https://github.com/johnajunghans/tarot-vault-v1
- license: none
- readme: none
## 0.5_Change Log
*This is a space to track all updates.*
### 0.5.1_Example Entry

**02/02/2026 (date) -- 0.5.1 (step) -- Claude 4.5 Sonnet (model)**
Summary of actions taken (be as concise as possible):
- Action 1 
- Action 2
	- Sub-action 1
	- Sub-action 2
- Action 3

Future considerations/recommendations/warnings (Anything at all to consider about this topic moving forward)
- Future consideration/recommendation/warning 1
- Future consideration/recommendation/warning 2
- Future consideration/recommendation/warning 3
### 0.5.2_Entries
*Ordered with most recent at the top*

**02/04/2026 -- 1.2.3 -- GPT-5.2 Codex XHigh**
Summary of actions taken:
- Added `app-topbar.tsx` with sidebar toggle, breadcrumb navigation, and a New dropdown
- Wired the app topbar into `/app` layout using `SidebarInset`
- Implemented breadcrumb label formatting with ChevronRight separators
- Added a placeholder center title slot for future page-specific headings
- Ran `npm run lint` (warnings noted below)

Future considerations/recommendations/warnings:
- Breadcrumbs currently mirror route segments; revisit for custom labels later
- New dropdown items intentionally have no actions yet
- ESLint warnings remain for unused imports in `components/app/app-sidebar.tsx` and `convex/tests/spreads.test.ts`

**02/04/2026 -- 1.2.2 -- GPT-5.2 Codex XHigh**
Summary of actions taken:
- Made the sidebar header link to `/app`
- Rebuilt personal menu buttons with tooltips, router navigation, and an Interpretations entry
- Normalized personal route paths and icon sizing for collapsed state usability
- Added a Settings button in the footer (no action yet)
- Prevented collapsed group labels from blocking the last menu item (pointer-events fix)

Future considerations/recommendations/warnings:
- ESLint reports a pre-existing unused import warning in `convex/tests/spreads.test.ts`

**02/04/2026 -- 1.2.1 -- GPT-5.2 Codex XHigh**
Summary of actions taken:
- Updated `app/layout.tsx` metadata title to "Tarot Vault"
- Reworked `app/page.tsx` header with top-right site label and auth controls, plus signed-in redirect to `/app`
- Removed default template content from `app/page.tsx` in favor of a minimal landing message
- Added "site being built" copy and a simple pulse animation on the landing page
- Redirected `/app` to `/app/personal` in `app/app/page.tsx`
- Installed a subset of shadcn/ui components (avatar, badge, breadcrumb, card, collapsible, dropdown-menu, empty, label, popover, progress, radio-group, resizable, scroll-area, select, sonner, spinner, switch); remaining installs deferred to user

Future considerations/recommendations/warnings:
- Finish installing remaining shadcn/ui components from 0.2.1.1.2 (user to complete)
- `date-picker` is missing from the base-nova registry and may need a manual implementation

**02/04/2026 -- 1.1.5 -- Claude 4.5 Opus**
Summary of actions taken:
- Created comprehensive Vitest test infrastructure for Convex functions:
  - Updated `package.json` with test scripts and dependencies (vitest, @edge-runtime/vm)
  - Created `vitest.config.ts` configured with edge-runtime environment for Convex testing
  - Created `convex/tests/test.setup.ts` with modules glob pattern and schema export for reuse across tests
- Created test suite files in `/convex/tests/` directory:
  - `users.test.ts` (7 tests): Tests for `current`, `upsertFromClerk`, and `deleteFromClerk` functions
  - `readings.test.ts` (14 tests): Tests for `list`, `listStarred`, `create`, `update`, and `remove` functions
  - `spreads.test.ts` (19 tests): Tests for `list`, `getById`, `create`, `update`, and `remove` functions
  - `interpretations.test.ts` (19 tests): Tests for `list`, `listByReading`, `listBySource`, `create`, `update`, and `remove` functions
  - `http.test.ts` (5 tests): Tests for Clerk webhook endpoint handling (user.created, user.updated, user.deleted events)
- All tests cover:
  - Happy path scenarios (successful operations)
  - Error cases (not found, unauthorized access, validation failures)
  - User isolation/multi-tenancy verification
  - Data ordering and filtering
  - Optional field handling
- **Result**: All 64 tests pass successfully

Test coverage includes:
- Authentication and authorization checks
- CRUD operations on all tables
- Index-based query verification
- Ownership validation for user data
- Webhook event handling and validation
- Error message accuracy

Added npm test scripts:
- `npm run test` - Run tests in watch mode
- `npm run test:once` - Run tests once
- `npm run test:debug` - Run tests with debugger attached
- `npm run test:coverage` - Generate coverage report

Future considerations/recommendations/warnings:
- Tests provide a solid foundation for regression detection during future development
- Consider adding coverage reporting to CI/CD pipeline once deployed
- Additional integration tests may be needed for frontend-backend interactions
- Mock Clerk webhook signing should be kept consistent with production setup
- Consider adding performance/load tests for bulk operations before scaling to production
- All tests follow Convex testing best practices using convex-test library and Vitest framework

**02/04/2026 -- 1.1.4 -- GPT 5.2 codex + Claude Sonnet 4.5**
What was completed:
- Conducted comprehensive code review of step 1.1.3 implementation
- Added missing `returns` validators to all Convex functions (users.ts, all table functions)
- Removed disallowed `.filter()` usage in interpretations.list query, replaced with proper index-based query
- Refactored validator pattern to use single source of truth:
	- Created one base validator per table (excluding system fields `_id`, `_creationTime`)
	- Schema uses base validators in `defineTable()`
	- System fields added via `.extend()` inline in query return types where needed
- Fixed create/update argument validators to properly separate concerns:
	- Create args: omit only server-controlled fields (userId, updatedAt) from base validator
	- Update args: use `.omit()`, `.partial()`, and `.extend({ _id })` pattern for true partial updates
	- Removed redundant omission of system fields (already excluded in base validators)
- Corrected `starred` field treatment - changed from server-controlled to user-controlled (available in create/update)
- Standardized all delete and lookup operations to use `_id` consistently (removed mixed usage of `id` vs `_id`)
- Exported base validators from schema.ts for reuse in function files

Technical improvements:
- DRY validator pattern using `.omit()`, `.partial()`, `.extend()` methods
- Proper separation of system fields (auto-generated), server-controlled fields (derived from auth/timestamps), and user-controlled fields
- Type-safe partial updates with explicit required `_id` field
- Consistent API contracts across all table operations

Files modified:
- convex/schema.ts - simplified to single validator per table
- convex/users.ts - added returns validators
- convex/readings.ts - refactored args validators, fixed starred handling, standardized _id
- convex/spreads.ts - refactored args validators, standardized _id
- convex/interpretations.ts - refactored args validators, removed filter, standardized _id

**02/03/2026 (date) -- 1.1.3 (step) -- Claude 4.5 Sonnet (model)**
Summary of actions taken:
- Created `/convex/readings.ts` with complete CRUD operations for readings table:
	- `list`: Query to get 10 most recent readings ordered by updatedAt desc (uses `by_userId_and_updatedAt` index)
	- `listStarred`: Query to get starred readings (uses `by_userId_and_starred` index)
	- `create`: Mutation to insert new reading with validation for spread and parent reading references
	- `update`: Mutation to patch existing reading with ownership verification
	- `remove`: Mutation to delete reading with ownership verification
- Created `/convex/interpretations.ts` with complete CRUD operations for interpretations table:
	- `list`: Query to get 10 most recent interpretations ordered by updatedAt desc
	- `listByReading`: Query to get all interpretations for a specific reading (uses `by_readingId` index)
	- `listBySource`: Query to get interpretations filtered by source type (uses `by_userId_and_source` index)
	- `create`: Mutation to insert new interpretation with reading validation
	- `update`: Mutation to patch content and focus fields with ownership verification
	- `remove`: Mutation to delete interpretation with ownership verification
- Created `/convex/spreads.ts` with complete CRUD operations for spreads table:
	- `list`: Query to get 10 most recent spreads ordered by updatedAt desc (uses `by_userId_and_updatedAt` index)
	- `getById`: Query to get specific spread by ID with ownership verification
	- `create`: Mutation to insert new spread with validation that numberOfCards matches positions array length (1-78)
	- `update`: Mutation to patch existing spread with validation and ownership verification
	- `remove`: Mutation to delete spread with ownership verification
- All functions use `getCurrentUserOrThrow` helper from `users.ts` for authentication
- All queries filter by authenticated user's userId for multi-tenant data isolation
- All mutations set `updatedAt: Date.now()` on create and update operations
- All create operations return the new document ID
- All update and remove operations return null
- Comprehensive error handling with descriptive messages for not found and unauthorized cases

Future considerations/recommendations/warnings:
- All indexes verified to support the query patterns used by these functions
- Foreign key validation ensures data integrity (spreads exist before readings reference them, readings exist before interpretations reference them)
- Consider adding pagination support for queries that may return many results (currently limited to 10)
- Consider adding batch operations for creating/updating multiple documents at once
- Future cascade delete logic needed when deleting spreads or readings that have dependent data
- The `interpretations.list` query uses filter + sort instead of index ordering - consider adding `by_userId_and_updatedAt` index if this becomes a performance bottleneck
- Starred readings can be queried efficiently with the dedicated `by_userId_and_starred` index
- All functions follow Convex best practices with proper validators on args and returns

**02/03/2026 (date) -- 1.1.2 (step) -- Claude 4.5 Sonnet (model)**
Summary of actions taken:
- Installed svix package for webhook signature verification
- Created `/convex/http.ts` HTTP router with `/clerk-users-webhook` endpoint
	- Converts request headers to plain object for action compatibility
	- Routes to internal action handler with proper response formatting
- Created `/convex/users.ts` with comprehensive user sync and management functions:
	- `handleClerkWebhook`: Internal action that verifies webhook signatures and handles Clerk events (user.created, user.updated, user.deleted)
	- `upsertFromClerk`: Internal mutation that creates new users with default settings or updates existing users
	- `deleteFromClerk`: Internal mutation that removes users when deleted in Clerk
	- `current`: Public query to get the currently authenticated user based on JWT token
	- `get`: Internal query to fetch user by ID
- Webhook handler extracts user data from Clerk events (authId, email, name) and syncs to database
- Default user settings initialized on creation:
	- appearance.theme: "system"
	- preferences.useReverseMeanings: "auto"
	- notifications.private.showToasts: true
- All timestamps use `Date.now()` for milliseconds since epoch consistency
- Token identifier constructed from Clerk JWT issuer domain and user authId

Future considerations/recommendations/warnings:
- **Add user settings management functions (getSettings, updateSettings) when building UI**
- Use `current()` query to get userId for readings, spreads, and interpretations
- Reference user settings for default preferences (reverse meanings, theme, AI tier)
- Consider adding structured logging for webhook events in production
- Implement error tracking for webhook processing failures
- Test webhook thoroughly with Clerk's webhook testing UI before production
- Handle user deletion cascades for related data (readings, spreads) in future steps
- Current implementation follows Convex best practices with proper internal/public function separation

**02/03/2026 (date) -- 1.1.1 (step) -- Claude 4.5 Sonnet (model)**
Summary of actions taken:
- Created complete Convex database schema in `/convex/schema.ts` with all four tables
	- users table: stores Clerk-synced user data with settings object
	- readings table: stores tarot reading sessions with cards, spreads, and metadata
	- interpretations table: stores user and AI-generated reading interpretations
	- spreads table: stores custom and default tarot card spreads
- Defined reusable Card validator type (id, position, reversed, notes)
- Implemented all required indexes for efficient querying:
	- users: by_authId (for Clerk webhook lookup)
	- readings: by_userId_and_updatedAt, by_userId_and_starred
	- interpretations: by_readingId, by_userId_and_source
	- spreads: by_userId_and_updatedAt
- Updated mvp-build.md section 0.2.2.1.1 to document all indexes under each table specification
- Removed redundant createdAt fields (Convex auto-generates _creationTime)
- Changed all timestamp fields to use numbers (milliseconds since epoch) instead of strings

Future considerations/recommendations/warnings:
- Index design supports all planned query operations in step 1.1.3
- Convex will auto-generate TypeScript types in `convex/_generated/dataModel.d.ts` on next dev server start
- All timestamps use milliseconds since epoch (numbers) for consistency with Convex's _creationTime
- ~~aiMetadata object is currently required for all interpretations - consider making it optional for self-sourced interpretations or using a discriminated union based on source type (DONE by Tony)~~
- Consider adding index on readings.starred alone if filtering starred readings without userId becomes needed

# 1_Build Plan
## ~~1.1_Database & Auth Setup~~
### ~~1.1.1_Create Database Tables~~
~~1. Create the database tables (found in 0.2.2.1.1) in /convex/schema.ts~~
~~2. Create indexes for all tables~~
~~3. Update 0.2.2.1.1 to include index specifications for all tables~~
### 1.1.2_Create Webhook to Sync Clerk with Users table
1. Follow guide located [here](https://docs.convex.dev/auth/database-auth#set-up-webhooks) to create /convex/users.ts file and /convex/http.ts file
	1. Note: webhook has already been configured in Clerk with signing secret added as env variable to Convex
2. Scan project and make recommendations for further updates and improvements to the authentication structure.
### ~~1.1.3_Create database table functions~~
~~1. Create files in /convex for each table (apart from users.ts which should already exist):~~
	~~1. /convex/readings.ts~~
	~~2. /convex/interpretations.ts~~
	~~3. /convex/spreads.ts~~
~~2. Within each file, create query and mutation functions (*Note: check to ensure that indexes are correct for handling all functions*)~~
	~~1. All tables should have the following functions:~~
		~~1. get documents (max 10)~~
			~~1. should be ordered by 'updatedAt' property so most recently updated comes first~~
		~~2. create/insert document~~
		~~3. update document~~
		~~4. delete document~~
	~~2. Then certain tables should have extra functions:~~
		~~1. readings~~
			~~1. get starred readings (i.e. readings with property 'starred' = true)~~
		~~2. spreads~~
			~~1. get specific spread given id~~
		~~3. interpretations~~
			~~1. get interpretations by 'readingId' (foreign key)~~
			~~2. get interpretations by 'source' (either 'self' or 'ai')~~

~~### 1.1.4_Code Review~~
	1. Review all code written in 1.1.1 - 1.1.3 and fix any major bugs or vulnerabilities.
~~### 1.1.5_Create Convex Tests~~
	1. Follow instructions and examples at [Convex Tests](https://docs.convex.dev/testing/convex-test) for writing tests and create one test for each table.
## 1.2_Frontend Setup
*Create placeholder landing page and main components shared by all routes on app.*
### ~~1.2.1_Setup~~
~~1. Update /app/layout.tsx in the following ways~~
	~~1. Update site title~~
~~2. Update /app/page.tsx in the following ways~~
	~~1. Move signin/signup buttons to top right of topbar~~
	~~2. Add site name to top right of topbar~~
	~~3. Route to /app when user is signed in~~
	~~4. For now, /app should route to /app/personal~~
~~3. Install all shadcn components listed in 0.2.1.1.2~~
### ~~1.2.2_App-Sidebar~~
~~1. Complete app-sidebar.tsx component. There should be three sections: header, content, and footer.~~
	~~1. Header: mostly already created~~
		~~1. Changes to make~~
			~~1. Should route to /app when clicked~~
	~~2. Content~~
		~~1. Already includes:~~
			~~1. Personal group label that routes to /app/personal~~
			~~2. Menu group for personal with buttons for readings and spreads~~
		~~2. Issues to fix~~
			~~1. When sidebar is collapsed, spreads icon blocks button being clicked on (mouse has to be carefully pointed at button space around icon to actually click link)~~
			~~2. Tooltips do not show for readings and spreads when sidebar is collapsed~~
		~~3. Changes to make~~
			~~1. Add Interpretations button in personal menu group with Prism icon~~
			~~2. Add Clerk's UserButton component to button of footer (already done)~~
			~~3. Add button for settings using Settings01Icon. This should not trigger anything yet.~~ 
### ~~1.2.3_App-Topbar~~
~~1. Create app-topbar.tsx component in components/app folder~~
	~~1. This component should be present for all /app routes and should have three sections (horizontal flex with justify-between to space out):~~
		~~1. Left section: 2 sections (flex with gap-2)~~
			~~1. Left section: Sidebar toggle~~
				~~1. Should use PanelLeftCloseIcon or PanelLeftOpenIcon depending on whether sidebar is open or closed.~~
			~~2. Right section: breadcrumbs showing current route and ability to easily go back.~~ 
				~~1. Should not show 'app'.~~ 
				~~2. Should use shadcn breadcrumbs component~~
				~~3. Should use ChevronRight icon for arrows~~
				~~4. Example (if at app/personal/readings/new-reading): Personal > Readings > New Reading~~
		~~2. Middle section: Page title~~
			~~1. Will only appear when viewing a page that displays a single doc with a name/id (e.g. viewing a single reading or creating a new reading, etc.)~~
			~~2. Do NOT try and implement any complex logic for this yet. User will manually create this logic later. For now just include placeholder div.~~
		~~3. Right section: New X Button~~
			~~1. Should be a shadcn button of primary variant~~
			~~2. Should trigger a dropdown menu when clicked showing three options (to the right of each text option should be an icon as show below in parentheses):~~ 
				~~1. New Reading (LibraryIcon)~~
				~~2. New Spread (Card01Icon)~~
				~~3. New Interpretation (Prism)~~
			~~3. Do not yet create any action for when an option is pressed.~~ 






